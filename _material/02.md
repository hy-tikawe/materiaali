---
title: 2. Tietokannan käyttäminen
slug: osa2
sections:
- Tietokanta sovelluksessa
- Tietokantamoduuli
- Istunnot ja kirjautuminen
- Virheiden etsiminen
---

<style>
img {
    border-style: solid;
    border-color: black;
    border-width: 1px;
    width: 80%;
    margin-top: 40px;
    margin-bottom: 40px;    
}
</style>

# 2. Tietokannan käyttäminen

Tietokannan avulla web-sovellus voi tallentaa palvelimelle tietoa ja näyttää sivuilla tallennettua tietoa. Ideana on, että sovellus muodostaa sivupyynnön tullessa yhteyden tietokantaan ja suorittaa tietokantakomentoja.

Tällä kurssilla käytämme sovelluksissa SQLite-tietokantaa, jota on käytetty myös kurssilla _Tietokantojen perusteet_. SQLite-tietokannan käyttäminen on helppoa, koska tietokanta tallennetaan yhteen tiedostoon ja Pythonin standardikirjastossa on valmis moduuli tietokannan käsittelemiseen.

## Tietokanta sovelluksessa

Voimme käyttää SQLite-tietokantaa web-sovelluksessa luomalla ensin tietokannan, jossa on sovelluksen tarvitsemat taulut. Tämän jälkeen voimme yhdistää tietokantaan ja suorittaa tietokantakomentoja sovelluksen koodissa.

Tutustumme seuraavaksi tietokannan käyttämiseen kahden esimerkin kautta.

### Kävijälaskuri

Ensimmäinen tietokantaa käyttävä sovelluksemme on kävijälaskuri, joka tallentaa tietokantaan rivin tietoa aina, kun käyttäjä lataa sovelluksen etusivun. Lisäksi sovellus hakee tietokannasta taulun rivien määrän ja näyttää sen avulla tiedon, montako kertaa sivu on ladattu.

Luodaan ensin tietokanta tiedostoon `database.db`. Sovellus käyttää taulua `visits`, jonka rakenne on seuraava:

```sql
CREATE TABLE visits (
    id INTEGER PRIMARY KEY,
    visited_at TEXT
)
```

Sarake `id` on automaattisesti kasvava id-numero, ja sarake `visited_at` sisältää vierailun ajankohdan. Koska SQLite ei sisällä erillistä tietotyyppiä päivämäärän ja kellonajan tallentamiseen, tässä on käytetty tietotyyppiä `TEXT`.

Voimme luoda tietokannan käytännössä seuraavasti:

```console
$ sqlite3 database.db
sqlite> CREATE TABLE visits (id INTEGER PRIMARY KEY, visited_at TEXT);
sqlite> .quit
```

Sovelluksen koodi on seuraava:

{: .code-title }
app.py
```python
from flask import Flask
import sqlite3

app = Flask(__name__)

@app.route("/")
def index():
    db = sqlite3.connect("database.db")
    db.execute("INSERT INTO visits (visited_at) VALUES (datetime('now'))")
    db.commit()
    count = db.execute("SELECT COUNT(*) FROM visits").fetchone()
    db.close()
    return "Sivua on ladattu " + str(count[0]) + " kertaa"
```

Kun sovelluksen etusivu ladataan, sovellus muodostaa yhteyden tietokantaan. Sovellus suorittaa ensin `INSERT`-komennon, joka lisää tietokantaan uuden rivin. Käytössä on SQLite-funktio `datetime`, jonka avulla riville saadaan haettua nykyinen päivämäärä ja kellonaika. Komennon suorituksen jälkeen kutsutaan vielä metodia `commit`, jolloin lisätty rivi siirtyy pysyvästi tietokantaan.

Tämän jälkeen sovellus suorittaa `SELECT`-komennon, joka hakee tietokannasta taulun `visits` rivien määrän. Tämä määrä ilmaisee, montako kertaa sivu on ladattu. Metodi `fetchone` palauttaa tuloksen muuttujaan `count` tuplena, minkä takia lauseke `count[0]` antaa rivien määrän.

Sovellus näyttää seuraavalta, kun sivua on ladattu viisi kertaa:

![](../img/counter.png)

Voimme mennä myös sovelluksen käyttämisen jälkeen katsomaan tietokannasta, mitä tietoa sovellus on tallentanut. Voimme katsoa esimerkiksi kaikki taulussa `visits` olevat rivit:

```console
$ sqlite3 database.db
sqlite> SELECT * FROM visits;
1|2024-10-31 08:45:05
2|2024-10-31 08:45:06
3|2024-10-31 08:45:06
4|2024-10-31 08:45:06
5|2024-10-31 08:45:07
```

Tästä näkee, että sovelluksen etusivu on ladattu viisi kertaa. Taulussa jokainen lataus näkyy yhtenä rivinä, jossa on id-numero ja ajankohta. Huomaa, että id-numeroita ja ajankohtia ei tällä hetkellä näytetä sovelluksessa mutta ne jäävät kuitenkin tietokantaan talteen mahdollista myöhempää käyttöä varten.

Jos haluamme nollata laskurin, voisimme myös suorittaa seuraavan komennon:

```console
sqlite> DELETE FROM visits;
```

Tämän komennon suorittamisen jälkeen taulu `visits` on tyhjä ja kävijöiden laskeminen alkaa alusta.

### Keskustelualue

Seuraava sovelluksemme on yksinkertainen keskustelualue. Sovelluksen etusivu näyttää lähetetyt viestit, ja uuden viestin voi lähettää lomakkeen avulla. Sovellus olettaa, että tietokannassa on seuraava taulu `messages`:

```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY,
    content TEXT
);
```

Sovelluksen koodi on seuraava:

{: .code-title }
app.py
```python
from flask import Flask
from flask import redirect, render_template, request
import sqlite3

app = Flask(__name__)

@app.route("/")
def index():
    db = sqlite3.connect("database.db")
    messages = db.execute("SELECT content FROM messages").fetchall()
    db.close()
    return render_template("index.html", count=len(messages), messages=messages)

@app.route("/new")
def new():
    return render_template("new.html")

@app.route("/send", methods=["POST"])
def send():
    content = request.form["content"]
    db = sqlite3.connect("database.db")
    db.execute("INSERT INTO messages (content) VALUES (?)", [content])
    db.commit()
    db.close()
    return redirect("/")
```

Etusivulla sovellus hakee kaikki viestit tietokannasta ja välittää sivupohjalle viestien määrän sekä niiden sisällöt. Tällä sivulla on linkki sivulle `/new`, jonka kautta pystyy lähettämään uuden viestin.

Sivulla `/new` oleva lomake ohjaa sivulle `send`, joka lähettää viestin. Tässä tilanteessa sovellus tallentaa viestin tietokantaan ja ohjaa sitten käyttäjän takaisin etusivulle funktiolla `redirect`.

Sovellus käyttää kahta sivupohjaa, jotka on tallennettu hakemistoon `templates`:

{: .code-title }
index.html
```jinja
{% raw %}Viestien määrä: {{ count }}
<hr>
{% for message in messages %}
{{ message[0] }}
<hr>
{% endfor %}
<a href="/new">Lähetä viesti</a>{% endraw %}
```

{: .code-title }
new.html
```jinja
{% raw %}<form action="/send" method="post">
Viesti: <br>
<textarea name="content" rows="3" cols="40"></textarea>
<br>
<input type="submit" value="Lähetä">
</form>{% endraw %}
```

Sovelluksen käyttäminen voi näyttää seuraavalta:

![](../img/messages1.png)

![](../img/messages2.png)

![](../img/messages3.png)


## Tietokantamoduuli

## Istunnot ja kirjautuminen

## Virheiden etsiminen
