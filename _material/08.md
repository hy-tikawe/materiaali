---
title: 8. Tietoturva
slug: osa8
sections:
- SQL-injektio
- XSS-haavoittuvuus
---

<style>
img {
    border-style: solid;
    border-color: black;
    border-width: 1px;
    width: 80%;
    margin-top: 40px;
    margin-bottom: 40px;    
}
</style>

# 8. Tietoturva

## SQL-injektio

SQL-injektio on tietoturva-aukko, jossa hyökkääjän antama syöte muuttaa SQL-komennon rakennetta. Tämän avulla hyökkääjä pystyy hakemaan tai muuttamaan tietoa, johon hänellä ei pitäisi olla oikeutta.

Hyvä tapa estää SQL-injektio on käyttää SQL-komennoissa parametreja, kuten on tehty kaikissa tämän kurssin esimerkeissä. Esimerkiksi seuraavassa SQL-komennossa on kaksi parametria, joihin sijoitetaan muuttujien `content` ja `id` arvot:

{: .code-title }
forum.py
```python
def update_message(id, content):
    sql = "UPDATE messages SET content = ? WHERE id = ?"
    db.execute(sql, [content, id])
```

Esimerkiksi kun `content` on `"testi"` ja `id` on 2, SQL-komennosta tulee:

```sql
UPDATE messages SET content = 'testi' WHERE id = 2
```

Katsotaan sitten, mitä tapahtuu, kun ei käytetä parametreja ja muuttujien arvot sijoitetaan suoraan SQL-komennon osaksi:

{: .code-title }
forum.py
```python
def update_message(id, content):
    sql = "UPDATE messages SET content = '" + content + "' WHERE id = " + str(id)
    db.execute(sql)
```

Tässä tilanteessa hyökkääjä pystyy tekemään SQL-injektion, joka muuttaa SQL-komennon rakennetta. Hyökkäjä voi esimerkiksi lähettää viestin, mennä sitten muokkaussivulle ja kirjoittaa lomakkeeseen seuraavan viestin:

![](../img/08-sqlinj1.png)

Kun hyökkääjä lähettää lomakkeen, tämän seurauksena _jokaisen_ keskustelussa olevan viestin sisällöksi tulee "Hakkeri iski!":

![](../img/08-sqlinj2.png)

Hyökkäys perustuu siihen, että viestissä on merkki `'`, joka on SQL:ssä merkkijonon lopetusmerkki. Tämän jälkeen viestissä on vielä merkit `--`, jotka tarkoittavat SQL:ssä kommenttia. Tämän seurauksena SQL-komennosta tulee:

```sql
UPDATE messages SET content = 'Hakkeri iski!' --' WHERE id = 2
```

Tämä tarkoittaa samaa kuin seuraava komento:

```sql
UPDATE messages SET content = 'Hakkeri iski!'
```

Komennosta siis katoaa lopussa oleva ehto `WHERE id = 2` ja komento muuttaa _jokaisen_ keskustelussa olevan viestin sisällön.

Palataan sitten tilanteeseen, jossa SQL-komennossa on käytetty parametreja:

{: .code-title }
forum.py
```python
def update_message(id, content):
    sql = "UPDATE messages SET content = ? WHERE id = ?"
    db.execute(sql, [content, id])
```

Tämän ansiosta hyökkäys epäonnistuu:

![](../img/08-sqlinj3.png)

Nyt kun muuttuja liitetään parametriksi, siinä olevat `'` -merkit muutetaan automaattisesti muotoon `''`, jolloin ne eivät lopeta merkkijona vaan tulevat merkkijonon osaksi. Tämän seurauksena SQL-komennosta tulee:

```sql
UPDATE messages SET content = 'Hakkeri iski!'' --' WHERE id = 2
```

Lisäämällä tietokantayhteyden avaamisen jälkeen metodin `set_trace_callback` kutsun voi tarkastella käytännössä, miten parametrit toimivat:

{: .code-title }
db.py
```python
def get_connection():
    ...
    db.set_trace_callback(print)
    ...
```

Nyt kaikki SQL-komennot tulostetaan sovelluksen lokiin niiden lopullisessa muodossa. Esimerkiksi äskeisessä hyökkäysyrityksessä lokiin tulevat seuraavat rivit:

```console
BEGIN 
UPDATE messages SET content = 'Hakkeri iski!'' --' WHERE id = 2
COMMIT
127.0.0.1 - - [05/Nov/2024 15:44:19] "POST /edit/2 HTTP/1.1" 302 -
```

Tästä näkee, miten tärkeää on käyttää parametreja SQL-komennoissa. Jos yhdessäkin komennossa ei ole käytetty parametreja, hyökkääjä voi koettaa hyödyntää sitä.

## XSS-aukko

XSS-aukko antaa hyökkääjälle mahdollisuuden lähettää sovellukseen HTML-koodia, joka käsitellään toisen käyttäjän selaimessa. Tämä on erityisen vaarallista, koska mukana voi olla myös suoritettavaa JavaScript-koodia.

Flaskissa sivupohjien ja funktion `render_template` käyttäminen estää automaattisesti XSS-aukon. Esimerkiksi jos käyttäjä kirjoittaa keskusteluun viestin, jossa on HTML-koodia, selain ei käsittele koodia:

![](../img/08-xss1.png)

![](../img/08-xss2.png)

Katsomalla selaimesta sivun lähdekoodia näkee, miten viesti on muuttunut:

```html
  <p>
    &lt;b&gt;Moikka&lt;/b&gt;
  </p>
```

Funktio `render_template` on muuttanut merkit `<` ja `>` entiteeteiksi `&lt;` ja `&gt;`, minkä ansiosta merkkejä ei tulkita HTML-komennon osaksi vaan ne näytetään sellaisenaan sivulla.

Automaattinen HTML-koodin käsittelyn esto voidaan ottaa pois lisäämällä sivupohjaan merkintä `safe` halutun parametrin kohdalle:

{: .code-title }
thread.html
```jinja
  {% raw %}<p>
    {{ message.content | safe }}
  </p>{% endraw %}
```

Tässä `safe` tarkoittaa, että parametrin sisältö tiedetään turvalliseksi ja siinä olevan HTML:n voi näyttää. Tämän muutoksen jälkeen muotoilu näkyy viestissä:

![](../img/08-xss3.png)

Näin ei kuitenkaan kannata tehdä, koska käyttäjän lähettämässä viestissä voi olla mitä tahansa koodia eikä ole tietoa sen turvallisuudesta.

HTML-koodin osana on JavaScript-koodia, jonka käsittely selaimessa on erityisen vaarallista. Esimerkiksi käyttäjä voi lähettää seuraavan viestin:

![](../img/08-xss4.png)

Nyt aina kun käyttäjä menee lukemaan ketjua, näkyviin tulee ikkuna, jossa on hyökkääjän viesti:

![](../img/08-xss5.png)
